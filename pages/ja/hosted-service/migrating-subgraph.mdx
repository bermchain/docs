---
title: 既存のサブグラフをグラフネットワークに移行する
---

## イントロダクション

本ガイドは、サブグラフをホステッドサービスからThe Graph Networkに移行するためのガイドです。The Graph Networkへの移行は、Opyn、UMA、mStable、Audius、PoolTogether、Livepeer、RAI、Enzyme、DODO、Opyn、Pickle、BadgerDAOなどのプロジェクトで成功を収めており、これらのプロジェクトはすべて、ネットワーク上のIndexerが提供するデータに依存しています。現在、The Graph Networkには200以上のサブグラフが登録されており、クエリフィーを生成し、Web3データのインデックスを積極的に作成しています。

これで、分散型ネットワークへの移行やサブグラフの管理方法について、必要なことがすべてわかるようになります。移行作業は短時間で完了し、サブグラフはThe Graph Networkならではの信頼性とパフォーマンスを永遠に享受することができます。

### 既存のサブグラフのグラフネットワークへの移行

1. 最新版のgraph-cliをインストールする:

```sh
npm install -g @graphprotocol/graph-cli
```

```sh
yarn global add @graphprotocol/graph-cli
```

2. [Subgraph Studio](https://thegraph.com/studio/)でサブグラフを作成する。その方法については、[Subgraph Studioのドキュメント](/studio/subgraph-studio)や[ビデオチュートリアル](https://www.youtube.com/watch?v=HfDgC2oNnwo)で説明されています。
3. メイン・プロジェクトのサブグラフ・リポジトリ内で、スタジオ上でデプロイとビルドを行うためにサブグラフを認証します。

```sh
graph auth --studio <DEPLOY_KEY>
```

4. ファイルを生成し、サブグラフをビルドする:

```sh
graph codegen && graph build
```

5. サブグラフをスタジオにデプロイします。StudioのUIで、サブグラフの名前に基づいた`<SUBGRAPH_SLUG>`を見つけることができます。

```sh
 graph deploy --studio <SUBGRAPH_SLUG>
```

6. スタジオのプレイグラウンドでクエリをテストします。ここでは、[Sushi - Mainnet Exchange Subgraph](https://thegraph.com/explorer/subgraph?id=0x4bb4c1b0745ef7b4642feeccd0740dec417ca0a0-0&view=Playground)の例を示します。

```sh
{
  users(first: 5) {
    id
    liquidityPositions {
      id
    }
  }
  bundles(first: 5) {
    id
    ethPrice
  }
}
```

7. 説明とサブグラフの詳細を記入し、最大3つのカテゴリーを選択してください。必要であれば、スタジオにプロジェクト画像をアップロードしてください。
8. Publish ボタンを押して、The Graph's Networkにサブグラフを公開します。

- 公開はオンチェーンのアクションであり、Ethereumでのガスの支払いが必要になることを覚えておいてください。トランザクションの例は[こちら](https://etherscan.io/tx/0xd0c3fa0bc035703c9ba1ce40c1862559b9c5b6ea1198b3320871d535aa0de87b)で見れます。価格はだいたい100gweiで0.0425ETHくらいです。
- サブグラフをアップグレードする必要がある場合は、アップグレード料金が発生します。アップグレードとは、既存のサブグラフの別バージョンをチェーン上に公開することです。アップグレードには費用がかかりますので、メインネットにデプロイする前に、Rinkebyでサブグラフをデプロイしてテストすることを強くお勧めします。また、そのサブグラフにシグナルがない場合、場合によってはGRTが必要になることもあります。そのサブグラフのバージョンにシグナル/キュレーションがある場合（auto-migrateを使用）、税金は分割されます。

これで完成です。公開されると、[The Graph Explorer](https://thegraph.com/explorer)でネットワーク上のサブグラフをライブで見ることができるようになります。

### ネットワーク上のサブグラフのアップグレード

ネットワーク上の既存のサブグラフをアップグレードしたい場合は、Graph CLIを使ってサブグラフの新バージョンをSubgraph Studioにデプロイすることで行うことができます。

1. 現在のサブグラフに変更を加える。Rinkebyに公開してSubgraph Studio上で小さな修正をテストするのが良いアイデアでしょう。
2. 以下のようにデプロイし、コマンドに新しいバージョンを指定します（例：v0.0.1、v0.0.2など）。

```sh
graph deploy --studio <SUBGRAPH_SLUG>
```

3. Subgraph Studioのプレイグラウンドでクエリを実行し、新バージョンをテストします。
4. 新しいバージョンをThe Graph Networkで公開します。これにはガスが必要であることを忘れてはなりません（上のセクションで説明）。

### オーナーアップグレード料金

アップグレードには、旧バージョンのサブグラフから新バージョンへのGRTの移行が必要です。つまり、アップグレードのたびに、新しいボンディングカーブが作成されます（ボンディングカーブの詳細は[こちら](/curating#bonding-curve-101)）。

新しいボンディングカーブは、新バージョンに移行されるすべてのGRTに対して2.5%のキュレーション税を請求します。オーナーはこのうちの50％、つまり1.25％を支払う必要があります。残りの1.25%はキュレーター全員が手数料として吸収します。このようなインセンティブ設計は、サブグラフのオーナーが再帰的なアップグレードコールでキュレーターの資金をすべて使い果たしてしまうことを防ぐために設けられています。以下の例は、あなたのサブグラフが積極的にキュレーションされている場合に限ります。キュレーション活動が行われていない場合、自分のサブグラフで自分にシグナルを送るためには、最低でも100GRTを支払わなければなりません。

- 100,000 GRTが、サブグラフのv1でauto-migrateを使用してシグナリングされます。
- 100,000 GRT が新しいボンディングカーブに移行され、97,500 GRT が新しいカーブに入り、2,500 GRT がバーンされます。
- オーナーは1250GRTをバーンして、料金の半分を支払うことになるります。オーナーはアップグレードの前にこの通貨をウォレットに入れておかないと、アップグレードは成功しません。これはアップグレードと同じトランザクションで行われます。

_この仕組みは現在ネットワーク上で稼働していますが、コミュニティではサブグラフの開発者がアップグレードにかかるコストを削減する方法を検討しています。_

### サブグラフの安定版の維持

サブグラフに多くの変更を加えている場合、継続的にアップグレードしてアップグレード費用を負担するのは得策ではありません。サブグラフの安定した一貫性のあるバージョンを維持することは、コストの観点からだけでなく、インデクサーが自信を持って同期時間を設定できるようにするためにも重要です。アップグレードを計画する際には、インデクサーの同期時間に影響が出ないように、インデクサにフラグを立てる必要があります。Discordの[#Indexers channel](https://discord.gg/8tgJ7rKW)チャンネルを利用して、サブグラフのバージョンアップをインデクサーに知らせることができます。

サブグラフは外部の開発者が利用するオープンAPIです。オープンAPIは、外部の開発者のアプリケーションを壊さないように、厳格な基準に従う必要があります。The Graph Networkでは、サブグラフの開発者は、インデクサーが新しいサブグラフを同期するのにかかる時間や、自分のサブグラフを使用している他の開発者のことを考慮しなければなりません。

### サブグラフのメタデータの更新

新しいバージョンを発行することなく、サブグラフのメタデータを更新することができます。メタデータには、サブグラフの名前、画像、説明、ウェブサイトのURL、ソースコードのURL、カテゴリなどが含まれます。開発者は、適用可能なすべてのフィールドを編集できるSubgraph Studioで、サブグラフの詳細を更新することでこれを行うことができます。

「**Update Subgraph Details in Explorer**」がチェックされていることを確認し、「**Save**」をクリックします。これがチェックされていると、新しいデプロイメントで新しいバージョンを公開することなく、エクスプローラでサブグラフの詳細を更新するオンチェーン トランザクションが生成されます。

## グラフネットワークにサブグラフを展開する際のベストプラクティス

1. サブグラフの開発にENS名を活用する

- ENSを設定する： https://app.ens.domains/
- ENS名を[こちら](https://thegraph.com/explorer/settings?view=display-name)の設定に追加します。

プロフィールが充実しているほど、サブグラフがインデックスやキュレーションされる可能性が高くなります。

## The Graph Networkのサブグラフを廃止する

サブグラフを廃止し、The Graph Networkから削除するには、[こちら](/developer/deprecating-a-subgraph) の手順に従います。

## The Graph Networkでのサブグラフのクエリと課金について

ホステッドサービスは、開発者が自分のサブグラフを自由にデプロイできるように設定されています。

The Graph Networkが真の意味で分散化されるためには、プロトコルのインセンティブの中核としてクエリ料が支払われる必要があります。APIの購読やクエリフィーの支払いに関する詳細は、[こちら](/studio/billing)の課金ドキュメントをご覧ください。

### ネットワーク上でのクエリ費用の見積もり

製品のUIにはまだ反映されていませんが、1ヶ月に支払う金額を予想されるクエリ量で割ることで、クエリごとの最大予算を設定することができます。

クエリの予算は自分で決めることができますが、インデクサーがその価格でクエリを提供してくれる保証はありません。ゲートウェイが、あなたが支払ってもよいと考えている価格以下でクエリを提供してくれるインデクサを紹介してくれた場合、あなたは予算**と**その価格の差分を支払うことになります。その結果、クエリ価格が低ければ、利用できるインデクサーの数が減り、受けるサービスの質に影響が出る可能性があります。クエリ価格が高いと、キュレーションや有名なインデクサーをサブグラフに引き寄せることができるので、有益です。

これはダイナミックで成長中の市場ですが、どのように関わるかは自分でコントロールできることを忘れないでください。プロトコルにもゲートウェイにも、上限や下限の価格は指定されていません。例えば、ネットワーク上のいくつかのdappsが支払う価格（週単位）を以下に示します。最後の列はGRTでのクエリ料を示していますのでご覧ください。例えば、[Pickle Finance](https://www.pickle.finance/)は1秒あたり8回のリクエストがあり、1週間で2.4GRTを支払っています。

![クエリ料](/img/QueryFee.png)

## その他のリソース

まだよくわからないという方も、ご安心ください。以下のリソースをチェックしたり、分散型ネットワークへのサブグラフの移行に関するビデオガイドをご覧ください:

<figure className="video-container">
  <iframe
    className="video-iframe"
    src="https://www.youtube.com/embed/CzdQ3dFFrjo"
    title="YouTube ビデオプレイヤー"
    frameBorder="0"
    allowFullScreen
></iframe>
</figure>

- [The Graph Networkのコントラクト](https://github.com/graphprotocol/contracts)
- [キュレーションコントラクト](https://github.com/graphprotocol/contracts/blob/dev/contracts/curation/Curation.sol) - GNSが包括する基本的なコントラクト
  - アドレス - `0x8fe00a685bcb3b2cc296ff6ffeab10aca4ce1538`
- [Subgraph Studioドキュメント](/studio/subgraph-studio)
