---
title: NEARでのサブグラフ構築
---

> グラフノードおよびホステッドサービスにおけるNEARのサポートはベータ版です。NEARサブグラフの構築に関するご質問は、near@thegraph.com までお問い合わせください。

このガイドは、[NEAR blockchain](https://docs.near.org/)上のスマートコントラクトを索引するサブグラフを構築するための入門書です。

## NEARとは？

[NEAR](https://near.org/)は、非中央集権的なアプリケーションを構築するためのスマートコントラクトプラットフォームです。詳細は[公式ドキュメント](https://docs.near.org/docs/concepts/new-to-near)をご覧ください。

## NEARサブグラフとは？

Graphは、ブロックチェーンのイベントを処理し、その結果得られたデータをGraphQL APIを介して簡単に利用できるようにするためのツールを開発者に提供するもので、個別にはサブグラフとして知られています。[Graph Node](https://github.com/graphprotocol/graph-node)がNEARイベントを処理できるようになったということは、NEARの開発者がスマートコントラクトの指標となるサブグラフを構築できるようになったということです。

サブグラフはイベントベースなので、チェーン上のイベントをリッスンしてから処理します。現在、NEARサブグラフでサポートされているハンドラーは2種類あります:

- ブロックハンドラ：新しいブロックごとに実行されます
- レシートハンドラ：指定されたアカウントでメッセージが実行されるたびに実行されます

[NEARのドキュメントより](https://docs.near.org/docs/concepts/transaction#receipt):

> レシートは、システム内で唯一実行可能なオブジェクトです。NEARプラットフォームで「トランザクションの処理」といえば、最終的にはどこかの時点で「レシートの適用」を意味します。

## NEARサブグラフの構築

`@graphprotocol/graph-cli`は、サブグラフを構築・展開するためのコマンドラインツールです。

`@graphprotocol/graph-ts`は、サブグラフ固有の型のライブラリです。

NEARサブグラフの開発には、バージョン`0.23.0`以上の`graph-cli`と、バージョン`0.23.0`以上の`graph-ts`が必要です。

> NEARサブグラフの構築は、Ethereumのインデックスを作成するサブグラフの構築と非常によく似ています。

サブグラフの定義には3つの側面があります:

**subgraph.yaml:**: サブグラフのマニフェストで、対象となるデータソースとその処理方法を定義します。NEARは新しい`種類`のデータソースです。

**schema.graphql:**: サブグラフのためにどのようなデータが保存されているか、そしてGraphQLを介してどのようにクエリを行うかを定義するスキーマファイル。NEARサブグラフの要件は、[既存のドキュメント](/developer/create-subgraph-hosted#the-graphql-schema)でカバーされています。

**AssemblyScript Mappings:**: [AssemblyScript code](/developer/assemblyscript-api)は、イベントデータから、スキーマで定義されたエンティティに変換するコードです。NEARサポートでは、NEAR固有のデータタイプと、新しいJSONパース機能が導入されています。

サブグラフの開発には2つの重要なコマンドがあります:

```bash
$ graph codegen #は、マニフェストで指定されたスキーマファイルから型を生成します。
$ graph build #は、AssemblyScriptファイルからWeb Assemblyを生成し、/buildフォルダにすべてのサブグラフファイルを準備します。
```

### サブグラフマニフェストの定義

サブグラフ マニフェスト (`subgraph.yaml`) は、サブグラフのデータ ソース、関心のあるトリガー、およびこれらのトリガーに対応して実行されるべき関数を特定します。NEARサブグラフのサブグラフマニフェストの例を以下に示します:

```yaml
specVersion: 0.0.2
schema:
  file: ./src/schema.graphql # link to the schema file
dataSources:
  - kind: near
    network: near-mainnet
    source:
      account: app.good-morning.near # This data source will monitor this account
      startBlock: 10662188 # Required for NEAR
    mapping:
      apiVersion: 0.0.5
      language: wasm/assemblyscript
      blockHandlers:
        - handler: handleNewBlock # the function name in the mapping file
      receiptHandlers:
        - handler: handleReceipt # the function name in the mapping file
      file: ./src/mapping.ts # link to the file with the Assemblyscript mappings
```

- NEARサブグラフは、新しい`種類`のデータソース(`near`) を導入する
- ホスト側のグラフノード上の`ネットワーク`に対応している必要があります。ホスティングサービスでは、NEARのメインネットは`near-mainnet`,、NEARのテストネットは`near-testnet`です。
- NEARのデータソースには、オプションで`source.account`フィールドが用意されており、これは[NEAR account](https://docs.near.org/docs/concepts/account)に対応する人間が読めるIDであり、アカウントまたはサブアカウントである可能性があります。

NEARデータソースは2種類のハンドラーをサポートしています:

- `blockHandlers`: 新しいNEARブロックごとに実行され、`source.account` は必要ありません。
- `receiptHandlers`:データソースの`source.account`が受信者であるすべてのレシートで実行されます。完全一致のみ処理されることに注意してください（[subaccounts](https://docs.near.org/docs/concepts/account#subaccounts)は独立したデータソースとして追加する必要があります）。

### Schema Definition

Schema Definitionは、結果として得られるサブグラフ・データベースの構造と、エンティティ間の関係を記述します。これは元のデータソースに依存しません。サブグラフのスキーマ定義の詳細は[こちら](/developer/create-subgraph-hosted#the-graphql-schema)をご覧ください。

### AssemblyScript Mappings

イベントを処理するためのハンドラは[AssemblyScript](https://www.assemblyscript.org/)で書かれています。

NEARインデックスは、[AssemblyScript API](/developer/assemblyscript-api)にNEAR固有のデータタイプを導入します。

```typescript

class ExecutionOutcome {
      gasBurnt: u64,
      blockHash: Bytes,
      id: Bytes,
      logs: Array<string>,
      receiptIds: Array<Bytes>,
      tokensBurnt: BigInt,
      executorId: string,
  }

class ActionReceipt {
      predecessorId: string,
      receiverId: string,
      id: CryptoHash,
      signerId: string,
      gasPrice: BigInt,
      outputDataReceivers: Array<DataReceiver>,
      inputDataIds: Array<CryptoHash>,
      actions: Array<ActionValue>,
  }

class BlockHeader {
      height: u64,
      prevHeight: u64,// Always zero when version < V3
      epochId: Bytes,
      nextEpochId: Bytes,
      chunksIncluded: u64,
      hash: Bytes,
      prevHash: Bytes,
      timestampNanosec: u64,
      randomValue: Bytes,
      gasPrice: BigInt,
      totalSupply: BigInt,
      latestProtocolVersion: u32,
  }

class ChunkHeader {
      gasUsed: u64,
      gasLimit: u64,
      shardId: u64,
      chunkHash: Bytes,
      prevBlockHash: Bytes,
      balanceBurnt: BigInt,
  }

class Block {
      author: string,
      header: BlockHeader,
      chunks: Array<ChunkHeader>,
  }

class ReceiptWithOutcome {
      outcome: ExecutionOutcome,
      receipt: ActionReceipt,
      block: Block,
  }
```

これらのタイプは、ブロックハンドラとレシートハンドラに渡されます:

- ブロックハンドラーは、`Block`を受け取ります
- レシートハンドラーは`ReceiptWithOutcome`を受け取ります

その他、マッピング実行中のNEARサブグラフ開発者は、 [AssemblyScript API](/developer/assemblyscript-api)の残りの部分を利用できます。

これには、新しいJSON parsing functionが含まれています。NEARのログは、頻繁に文字列化されたJSONとして出力されます。新しい`json.fromString(...)`関数は、開発者がこれらのログを簡単に処理できるように、[JSON API](/developer/assemblyscript-api#json-api)の一部として利用できます。

## NEARサブグラフの展開

サブグラフを作成したら、インデックス作成のためにグラフノードにデプロイします。NEARサブグラフは、`>=v0.26.x`以上のグラフノードにデプロイすることができます（このバージョンはまだタグ付けされていないし、リリースもされていません）。

グラフのホステッドサービスは現在、NEAR mainnetとtestnetのベータ版のインデックス作成をサポートしており、ネットワーク名は以下の通りです:

- `near-mainnet`
- `near-testnet`

ホステッドサービスでのサブグラフの作成と展開に関する詳細は[こちら](/hosted-service/deploy-subgraph-hosted)をご覧ください。

簡単に説明すると、最初のステップはサブグラフを「作成」することです。ホスティングサービスでは、[ダッシュボード](https://thegraph.com/hosted-service/dashboard)から行います。"Add Subgraph "をクリックします。

サブグラフが作成されたら、CLIコマンドの`graph deploy`を使ってサブグラフをデプロイすることができます。

```
$ graph create --node <graph-node-url> subgraph/name # ローカルのグラフノードにサブグラフを作成します (Hosted Serviceでは、UI経由で実行)
$ graph deploy --node <graph-node-url> --ipfs https://api.thegraph.com/ipfs/ # 指定したIPFSエンドポイントにビルドファイルをアップロードし、マニフェストのIPFSハッシュに基づいて指定したグラフノードにサブグラフをデプロイします。
```

ノードの構成は、サブグラフがどこにディプロイされるかによって異なります。

#### ホステッドサービス:

```
graph deploy --node https://api.thegraph.com/deploy/ --ipfs https://api.thegraph.com/ipfs/ --access-token <your-access-token>
```

#### ローカルのグラフノード(デフォルトの設定に基づく):

```
graph deploy --node http://localhost:8020/ --ipfs http://localhost:5001
```

デプロイされたサブグラフは、Graph Nodeによってインデックス化され、その進捗状況は、サブグラフ自体にクエリして確認できます:

```
{
  _meta {
    block { number }
  }
}
```

### ローカルなグラフノードによるNEARのインデックス作成

NEARのインデックスを作成するグラフノードの運用には、以下のような運用要件があります:

- NEAR Indexer FrameworkとFirehose instrumentation
- NEAR Firehoseコンポーネント
- Firehoseエンドポイントが設定されたグラフノード

上記のコンポーネントの運用については、近日中に詳しくご紹介します。

## NEARサブグラフへのクエリ

NEARサブグラフのGraphQLエンドポイントは、既存のAPIインターフェイスを用いて、スキーマ定義によって決定されます。詳細は、[GraphQL API documentation](/developer/graphql-api) をご覧ください。

## サブグラフの例

参考までにサブグラフの例を紹介します:

[NEAR Blocks](https://github.com/graphprotocol/example-subgraph/tree/near-blocks-example)

[NEAR Receipts](https://github.com/graphprotocol/example-subgraph/tree/near-receipts-example)

## よくある質問

### ベータ版はどのように機能しますか？

NEARサポートはベータ版です。統合の改善を続ける中で、APIに変更が加えられる可能性があります。NEARサブグラフの構築をサポートし、最新の開発状況をお知らせしますので、near@thegraph.comまでメールをお送りください。

### サブグラフは、NEARとEVMの両チェーンに対してインデックスできますか？

いいえ、サブグラフは1つのチェーン/ネットワークのデータソースのみをサポートします。

### サブグラフは、複数のトリガーに反応することができますか？

現在、ブロックとレシートのトリガーのみがサポートされています。指定されたアカウントへのファンクションコールのトリガーを検討しています。また、NEARがネイティブイベントをサポートするようになれば、イベントトリガーのサポートも検討しています。

### レシートハンドラは、アカウントとそのサブアカウントに対してトリガーされますか？

レシートハンドラは、指定されたアカウントと完全に一致する場合にのみトリガされます。将来的にはさらに柔軟性を持たせることができます。

### NEARサブグラフは、マッピング中にNEARアカウントへのビューコールを行うことができますか？

これはサポートされていません。この機能がインデックス作成に必要かどうかを評価しています。

### NEARサブグラフでデータソーステンプレートを使用できますか？

これは現在サポートされていません。この機能がインデックス作成に必要かどうかを評価しています。

### イーサリアムのサブグラフは「pending」と「current」バージョンをサポートしていますが、NEARサブグラフの「pending」バージョンをデプロイするにはどうすればよいですか？

「pending」は、NEARサブグラフではまだサポートされていません。暫定的に、新しいバージョンを別の「named」サブグラフにデプロイし、それがチェーンヘッドと同期したときに、メインの「named」サブグラフに再デプロイすることができます。

### NEARサブグラフの構築に関する詳しい情報はどこで入手できますか？

サブグラフの開発に関する一般的な質問であれば、[Developer documentation](/developer/quick-start)に多くの情報が掲載されています。それ以外の場合は、[The Graph Protocol Discord](https://discord.gg/vtvv7FP)に参加して#nearチャンネルで質問するか、 near@thegraph.com にメールしてください。

## 参考文献

- [NEAR developer documentation](https://docs.near.org/docs/develop/basics/getting-started)
